{% extends "base.html" %}
{% from '_macros.html' import render_pagination %}

{% block title %}Gestión de Órdenes{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title mb-0">Panel de Órdenes</h3>
        <a href="{{ url_for('crear_orden') }}" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg"></i> Nueva Orden</a>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('admin_ordenes') }}" class="row g-3 align-items-center mb-4">
            <div class="col-md-8">
                <div class="btn-group">
                    <a href="{{ url_for('admin_ordenes', per_page=per_page, estado='todas') }}" class="btn {% if estado_filter == 'todas' %}btn-primary{% else %}btn-outline-primary{% endif %}">Todas</a>
                    <a href="{{ url_for('admin_ordenes', per_page=per_page, estado='abiertas') }}" class="btn {% if estado_filter == 'abiertas' %}btn-success{% else %}btn-outline-success{% endif %}">Abiertas</a>
                    <a href="{{ url_for('admin_ordenes', per_page=per_page, estado='cerradas') }}" class="btn {% if estado_filter == 'cerradas' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">Cerradas</a>
                </div>
            </div>
            <div class="col-md-4 d-flex justify-content-end align-items-center">
                <label for="per_page" class="form-label me-2 mb-0">Mostrar:</label>
                <select name="per_page" class="form-select w-auto" onchange="this.form.submit()">
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                </select>
                <input type="hidden" name="estado" value="{{ estado_filter }}">
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Solicitado Por</th>
                        <th>Fecha</th>
                        <th>Estado</th>
                        <th>Creado Por</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for orden in ordenes %}
                    <tr>
                        <td>{{ orden.id }}</td>
                        <td>{{ orden.solicitado_por }}</td>
                        <td>{{ orden.fecha_solicitud | localdatetime }}</td>
                        <td><span class="badge {% if orden.estado == 'ABIERTA' %}bg-success{% else %}bg-secondary{% endif %}">{{ orden.estado }}</span></td>
                        <td>{{ orden.creador.nombre }}</td>
                        <td>
                            {% if orden.estado == 'ABIERTA' %}
                                <a href="{{ url_for('cerrar_orden', orden_id=orden.id) }}" class="btn btn-sm btn-outline-warning" title="Cerrar Orden"><i class="bi bi-check-circle"></i></a>
                            {% endif %}
                            <form action="{{ url_for('admin_borrar_orden_historial', orden_id=orden.id) }}" method="POST" class="d-inline" onsubmit="return confirm('¿Estás seguro? El stock se restaurará si la orden está abierta.');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Borrar y Mover a Historial"><i class="bi bi-trash"></i></button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" class="text-center p-4">No hay órdenes que coincidan con el filtro.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{{ render_pagination(pagination, 'admin_ordenes') }}

{% endblock %}