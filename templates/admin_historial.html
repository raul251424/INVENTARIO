{% extends 'base.html' %}
{% from '_macros.html' import render_pagination %}

{% block title %}Historial de Órdenes{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title mb-0">Historial de Órdenes Borradas</h3>
        <div>
            <button type="submit" form="form-seleccion" class="btn btn-warning btn-sm"
                    onclick="return confirm('¿Estás seguro de que quieres eliminar los registros seleccionados?');">
                <i class="bi bi-trash"></i> Borrar Seleccionados
            </button>
            <form method="POST" action="{{ url_for('admin_borrar_historial_todo') }}" class="d-inline"
                  onsubmit="return confirm('¡ADVERTENCIA! Esta acción es irreversible. ¿Estás seguro de que quieres borrar TODO el historial?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-danger btn-sm">
                    <i class="bi bi-exclamation-triangle"></i> Borrar Todo el Historial
                </button>
            </form>
        </div>
    </div>
    <div class="card-body p-0">
        <form method="POST" action="{{ url_for('admin_borrar_historial_seleccion') }}" id="form-seleccion">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all"></th>
                            <th># Orden</th>
                            <th>Solicitante</th>
                            <th>Productos</th>
                            <th>Eliminado Por</th>
                            <th>Fecha de Eliminación</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in historial %}
                        <tr>
                            <td><input type="checkbox" name="historial_ids" value="{{ item.id }}" class="form-check-input"></td>
                            <td>{{ item.original_orden_id }}</td>
                            <td>{{ item.solicitante_info }}</td>
                            <td><small>{{ item.productos_info }}</small></td>
                            <td>{{ item.eliminado_por_info }}</td>
                            <td>{{ item.fecha_eliminacion | localdatetime }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="6" class="text-center p-4">El historial está vacío.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
</div>

{{ render_pagination(pagination, 'admin_historial') }}

{% endblock %}

{% block scripts %}
<script>
document.getElementById('select-all').addEventListener('click', function(event) {
    const checkboxes = document.querySelectorAll('input[name="historial_ids"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = event.target.checked;
    });
});
</script>
{% endblock %}