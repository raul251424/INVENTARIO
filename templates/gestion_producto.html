{% extends "base.html" %}
{% block title %}{{ 'Editar' if producto else 'Nuevo' }} Producto{% endblock %}

{% block content %}
<div class="card shadow-lg mb-4">
    <div class="card-header bg-primary text-white">
        <h3 class="card-title mb-0">
            <i class="bi bi-flask me-2"></i> 
            {% if producto %}Editar Producto{% else %}Añadir Nuevo Producto{% endif %}
        </h3>
    </div>

    <div class="card-body">
        <form method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="next" value="{{ next_url }}"/>

            <div class="row g-4">
                <!-- Columna izquierda: Identificación Química -->
                <div class="col-md-6 border-end">
                    <h4 class="mb-3 text-primary border-bottom pb-2">Identificación Química</h4>
                    
                    <div class="mb-3">
                        <label for="nombre" class="form-label fw-bold">Nombre del Producto</label>
                        <input type="text" class="form-control" id="nombre" name="nombre"
                               value="{{ producto.nombre if producto else '' }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="formula_molecular" class="form-label">Fórmula Molecular</label>
                        <input type="text" class="form-control" id="formula_molecular" name="formula_molecular"
                               value="{{ producto.formula_molecular if producto else '' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="nombre_IUPAC" class="form-label">Nombre IUPAC</label>
                        <input type="text" class="form-control" id="nombre_IUPAC" name="nombre_IUPAC"
                               value="{{ producto.nombre_IUPAC if producto else '' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="nombre_cana" class="form-label">Nombre Cana</label>
                        <input type="text" class="form-control" id="nombre_cana" name="nombre_cana"
                               value="{{ producto.nombre_cana if producto else '' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="cast_sigmg" class="form-label">CAS / SIGMG</label>
                        <input type="text" class="form-control" id="cast_sigmg" name="cast_sigmg"
                               value="{{ producto.cast_sigmg if producto else '' }}">
                    </div>
                </div>

                <!-- Columna derecha: Cantidad y Ubicación -->
                <div class="col-md-6">
                    <h4 class="mb-3 text-success border-bottom pb-2">Cantidad y Stock</h4>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-8">
                            <label for="cantidad" class="form-label fw-bold">Cantidad Actual</label>
                            <input type="number" step="any" class="form-control" id="cantidad" name="cantidad"
                                   value="{{ "{:,.2f}".format(producto.cantidad) if producto and producto.cantidad is not none else '0.00' }}" required>
                        </div>
                        <div class="col-4">
                            <label for="unidad_medida" class="form-label fw-bold">Unidad</label>
                            <select class="form-select" id="unidad_medida" name="unidad_medida">
                                {% set current_unidad = (producto.unidad_medida | lower) if producto else '' %}
                                <option value="" {% if not producto or current_unidad == '' %}selected{% endif %}>N/A</option>
                                <option value="g" {% if current_unidad == 'g' %}selected{% endif %}>Gramos (g)</option>
                                <option value="kg" {% if current_unidad == 'kg' %}selected{% endif %}>Kilogramos (kg)</option>
                                <option value="ml" {% if current_unidad == 'ml' %}selected{% endif %}>Mililitros (ml)</option>
                                <option value="L" {% if current_unidad == 'l' %}selected{% endif %}>Litros (L)</option>
                                <option value="u" {% if current_unidad == 'u' %}selected{% endif %}>Unidades (u)</option>
                                <option value="mol" {% if current_unidad == 'mol' %}selected{% endif %}>Moles (mol)</option>
                                <option value="cm" {% if current_unidad == 'cm' %}selected{% endif %}>Centímetros (cm)</option>
                                <option value="pkg" {% if current_unidad == 'pkg' %}selected{% endif %}>Paquetes (PKG)</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label for="stock_minimo" class="form-label text-danger">Stock Mínimo</label>
                            <input type="number" step="any" class="form-control" id="stock_minimo" name="stock_minimo"
                                   value="{{ "{:,.2f}".format(producto.stock_minimo) if producto and producto.stock_minimo is not none else '0.00' }}">
                        </div>
                        <div class="col-6">
                            <label for="estado_fisico" class="form-label">Estado Físico</label>
                            <select class="form-select" id="estado_fisico" name="estado_fisico">
                                {% set current_estado_fisico = (producto.estado_fisico | lower) if producto else '' %}
                                <option value="">N/A</option>
                                <option value="sólido" {% if current_estado_fisico == 'sólido' %}selected{% endif %}>Sólido</option>
                                <option value="líquido" {% if current_estado_fisico == 'líquido' %}selected{% endif %}>Líquido</option>
                                <option value="gaseoso" {% if current_estado_fisico == 'gaseoso' %}selected{% endif %}>Gaseoso</option>
                            </select>
                        </div>
                    </div>
                    
                    <h5 class="mb-3 text-info border-bottom pb-2">Ubicación Fija (Almacén)</h5>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label for="ubicacion" class="form-label">Ubicación Almacén</label>
                            <input type="text" class="form-control" id="ubicacion" name="ubicacion"
                                   value="{{ producto.ubicacion if producto else '' }}" placeholder="Ej: Refrigerador A">
                        </div>
                        <div class="col-6">
                            <label for="estante" class="form-label">Estante/Gabinete</label>
                            <input type="text" class="form-control" id="estante" name="estante"
                                   value="{{ producto.estante if producto else '' }}" placeholder="Ej: Estante 3, Gaveta 5">
                        </div>
                    </div>

                    <h5 class="mb-3 text-warning border-bottom pb-2">Estado Actual (Uso)</h5>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label for="ubicacion_actual" class="form-label fw-bold">Ubicación Uso (Actual)</label>
                            <select class="form-select" id="ubicacion_actual" name="ubicacion_actual">
                                {% set current_ubicacion_actual = (producto.ubicacion_actual | lower) if producto else 'lesqo' %}
                                <option value="lesqo" {% if current_ubicacion_actual == 'lesqo' %}selected{% endif %}>LESQO</option>
                                <option value="loefba" {% if current_ubicacion_actual == 'loefba' %}selected{% endif %}>LOEFBA</option>
                                <option value="otro" {% if current_ubicacion_actual == 'otro' %}selected{% endif %}>Otro</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label for="estado" class="form-label">Estado Envase</label>
                            <select class="form-select" id="estado" name="estado">
                                {% set current_estado = (producto.estado | lower) if producto else 'cerrado' %}
                                <option value="" {% if current_estado == '' %}selected{% endif %}>N/A (No Especificar)</option>
                                <option value="cerrado" {% if current_estado == 'cerrado' %}selected{% endif %}>Cerrado</option>
                                <option value="abierto" {% if current_estado == 'abierto' %}selected{% endif %}>Abierto</option>
                            </select>
                        </div>
                    </div>

                    {% set is_otro = (producto.ubicacion_actual | lower) == 'otro' if producto and producto.ubicacion_actual else false %}
                    
                    <!-- Este div es controlado por JS (ubicacion.js) -->
                    <div class="mb-3 d-none" id="otroUbicacionContainer"> 
                        <label for="otra_ubicacion_actual" class="form-label text-warning fw-bold">Detalle de Otra Ubicación</label>
                        <input type="text" class="form-control" id="otra_ubicacion_actual" name="otra_ubicacion_actual"
                               value="{{ producto.otra_ubicacion_actual if producto and producto.otra_ubicacion_actual else '' }}" 
                               placeholder="Ej: Laboratorio 301, Sala de equipos">
                    </div>

                </div>
            </div>

            <hr class="mt-4 mb-3">
            <button type="submit" class="btn btn-primary btn-lg me-2">
                <i class="bi bi-save me-1"></i> Guardar Producto
            </button>
            <a href="{{ next_url }}" class="btn btn-secondary btn-lg">Cancelar</a>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}\n<script src="{{ url_for('static', filename='js/ubicacion.js') }}"></script>\n{% endblock %}
